/**
 * 2007-2019 PrestaShop
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@prestashop.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade PrestaShop to newer
 * versions in the future. If you wish to customize PrestaShop for your
 * needs please refer to http://www.prestashop.com for more information.
 *
 * @author    Boxtal <api@boxtal.com>
 *
 * @copyright 2007-2019 PrestaShop SA / 2018-2019 Boxtal
 *
 * @license   http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 * International Registered Trademark & Property of PrestaShop SA
 */
const bxParcelPoint={trigger:".bx-select-parcel",initialized:!1,mapContainer:null,map:null,markers:[],init:function(){const e=this;e.initialized||(e.initialized=!0,e.mapContainer=document.querySelector("#bx-map"),e.mapContainer||e.initMap(),e.initCarriers(),e.on("body","click",e.trigger,function(){e.openMap(),e.getPoints()}),e.on("body","change",e.getAllCarrierInputsSelector(),function(){e.initCarriers()}),e.on("body","click",".bx-parcel-point-button",function(t){e.selectPoint(this.getAttribute("data-code"),unescape(this.getAttribute("data-name")),this.getAttribute("data-network"),unescape(this.getAttribute("data-street")),unescape(this.getAttribute("data-zipcode")),unescape(this.getAttribute("data-city")),unescape(this.getAttribute("data-country")),unescape(this.getAttribute("data-openinghours"))).then(function(){e.initCarriers(),e.closeMap()})["catch"](function(t){e.showError(t)})}))},initMap:function(){const e=this,t=document.createElement("div");t.setAttribute("class","bx-close"),t.setAttribute("title",bxTranslation.text.closeMap),t.addEventListener("click",function(){e.closeMap()});const n=document.createElement("div");n.setAttribute("id","bx-map-canvas");const o=document.createElement("div");o.setAttribute("id","bx-map-container"),o.appendChild(n);const r=document.createElement("div");r.setAttribute("id","bx-pp-container");const i=document.createElement("div");i.setAttribute("id","bx-map-inner"),i.appendChild(t),i.appendChild(o),i.appendChild(r),e.mapContainer=document.createElement("div"),e.mapContainer.setAttribute("id","bx-map"),e.mapContainer.appendChild(i),document.body.appendChild(e.mapContainer),mapboxgl.accessToken="whatever",e.map=new mapboxgl.Map({container:"bx-map-canvas",style:bxMapUrl,zoom:14}),e.map.addControl(new mapboxgl.NavigationControl);const a=document.createElement("img");a.setAttribute("src",bxMapLogoImageUrl);const c=document.createElement("a");c.setAttribute("href",bxMapLogoHrefUrl),c.setAttribute("target","_blank"),c.appendChild(a);const s=document.createElement("div");s.setAttribute("id","bx-boxtal-logo"),s.appendChild(c);const l=document.querySelector(".mapboxgl-ctrl-top-left");l&&l.appendChild(s)},initCarriers:function(){const e=this,t=e.getCarriers(),n=e.getSelectedCarrier();for(let o=0;o<t.length;o++){const r=t[o];if(null===r.querySelector(".bx-extra-content")){const e=document.createElement("div");e.setAttribute("class","col-sm-12 bx-extra-content"),r.appendChild(e)}const i=r.querySelector(".bx-extra-content");n===e.getCarrierId(r)?e.getSelectedCarrierText(n,i):i.innerHTML=""}},getCarriers:function(){let e=document.querySelectorAll(".delivery-option");return 0===e.length&&(e=document.querySelectorAll("td.delivery_option_radio")),0===e.length&&(e=document.querySelectorAll(".delivery_option")),e},openMap:function(){this.mapContainer.classList.add("bx-modal-show");let e=window.pageYOffset+(window.innerHeight-this.mapContainer.offsetHeight)/2;e<window.pageYOffset&&(e=window.pageYOffset),this.mapContainer.style.top=e+"px",this.map.resize()},closeMap:function(){this.mapContainer.classList.remove("bx-modal-show"),this.clearMarkers()},getPoints:function(){const e=this;e.getParcelPoints().then(function(t){e.addParcelPointMarkers(t.nearbyParcelPoints),e.fillParcelPointPanel(t.nearbyParcelPoints),e.addRecipientMarker(t.searchLocation),e.setMapBounds()})["catch"](function(t){e.showError(t)})},getParcelPoints:function(){const e=this;return new Promise(function(t,n){const o=e.getSelectedCarrier();o||n(bxTranslation.error.carrierNotFound);const r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState)if(200!==r.status)n();else{const e="object"==typeof r.response&&null!==r.response?r.response:JSON.parse(r.response);t(e)}},r.open("POST",bxAjaxUrl),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.responseType="json",r.send("route=getPoints&carrier="+encodeURIComponent(o)+"&cartId="+encodeURIComponent(bxCartId)+"&token="+encodeURIComponent(bxToken))})},addParcelPointMarkers:function(e){for(let t=0;t<e.length;t++)e[t].index=t,this.addParcelPointMarker(e[t])},generateParcelPointTagData:function(e){return' data-code="'+e.code+'" data-name="'+escape(e.name)+'" data-network="'+e.network+'" data-zipcode="'+escape(e.location.zipCode)+'" data-country="'+escape(e.location.country)+'" data-city="'+escape(e.location.city)+'" data-street="'+escape(e.location.street)+'" data-openinghours="'+escape(JSON.stringify(e.openingDays))+'" '},formatOpeningDays(e){for(var t=[],n=0;n<e.length;n++){var o=e[n];if(o.weekday){for(var r=o.weekday[0]+" ",i=o.openingPeriods,a=[],c=0;c<i.length;c++){var s=i[c],l=s.openingTime===undefined?"":s.openingTime,p=s.closingTime===undefined?"":s.closingTime;""!==l&&""!==p&&a.push(l+"-"+p)}for(;a.length<2;)a.push(bxTranslation.text.closedLabel);r+=a.join(" "),n%2==1&&(r='<span style="background-color: #d8d8d8;">'+r+"</span>"),t.push(r)}}return t.join("\n")},addParcelPointMarker:function(e){let t="<div class='bx-marker-popup'><b>"+e.parcelPoint.name+"</b><br/>"+e.parcelPoint.location.street+"<br/>"+e.parcelPoint.location.zipCode+" "+e.parcelPoint.location.city+'<br/><a href="#" class="bx-parcel-point-button" '+this.generateParcelPointTagData(e.parcelPoint)+"><b>"+bxTranslation.text.chooseParcelPoint+'</b></a><pre class="bx-parcel-point-schedule">'+this.formatOpeningDays(e.parcelPoint.openingDays)+"</pre>";const n=this.getMarkerHtmlElement(e.index+1),o=new mapboxgl.Popup({offset:25}).setHTML(t),r=new mapboxgl.Marker({element:n,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.parcelPoint.location.position.longitude),parseFloat(e.parcelPoint.location.position.latitude))).setPopup(o).addTo(this.map);this.markers.push(r),this.addRightColMarkerEvent(r,e.parcelPoint.code)},addRightColMarkerEvent:function(e,t){this.on("body","click",".bx-show-info-"+t,function(){e.togglePopup()})},formatHours:function(e){const t=e.split(":");return 3===t.length&&(e=t[0]+":"+t[1]),e},addRecipientMarker:function(e){const t=document.createElement("div");t.className="bx-marker-recipient";const n=new mapboxgl.Marker({element:t,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.position.longitude),parseFloat(e.position.latitude))).addTo(this.map);this.markers.push(n)},setMapBounds:function(){let e=new mapboxgl.LngLatBounds;for(let t=0;t<this.markers.length;t++){const n=this.markers[t];e=e.extend(n.getLngLat())}this.map.fitBounds(e,{padding:30,linear:!0})},fillParcelPointPanel:function(e){let t="";t+="<table><tbody>";for(let n=0;n<e.length;n++){const o=e[n];t+="<tr>",t+="<td>"+this.getMarkerHtmlElement(n+1).outerHTML,t+='<div class="bx-parcel-point-title"><a class="bx-show-info-'+o.parcelPoint.code+'">'+o.parcelPoint.name+"</a></div><br/>",t+=o.parcelPoint.location.street+"<br/>",t+=o.parcelPoint.location.zipCode+" "+o.parcelPoint.location.city+"<br/>",t+='<a class="bx-parcel-point-button" '+this.generateParcelPointTagData(o.parcelPoint)+'"><b>'+bxTranslation.text.chooseParcelPoint+"</b></a>",t+="</td>",t+="</tr>"}t+="</tbody></table>",document.querySelector("#bx-pp-container").innerHTML=t},getMarkerHtmlElement:function(e){const t=document.createElement("div");return t.className="bx-marker",t.innerHTML=e,t},selectPoint:function(e,t,n,o,r,i,a,c){const s=this;return new Promise(function(l,p){const d=s.getSelectedCarrier();d||p(bxTranslation.error.carrierNotFound);const u=new XMLHttpRequest;u.onreadystatechange=function(){4===u.readyState&&(200!==u.status?p(bxTranslation.error.couldNotSelectPoint):l())},u.open("POST",bxAjaxUrl),u.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),u.responseType="json",u.send("route=setPoint&carrier="+encodeURIComponent(d)+"&code="+encodeURIComponent(e)+"&name="+encodeURIComponent(t)+"&address="+encodeURIComponent(o)+"&zipcode="+encodeURIComponent(r)+"&city="+encodeURIComponent(i)+"&country="+encodeURIComponent(a)+"&openingHours="+encodeURIComponent(c)+"&network="+encodeURIComponent(n)+"&cartId="+encodeURIComponent(bxCartId)+"&token="+encodeURIComponent(bxToken))})},clearMarkers:function(){for(let e=0;e<this.markers.length;e++)this.markers[e].remove();this.markers=[]},getUniqueCarrier:function(){return document.querySelector('input[type="hidden"].shipping_method')},hasUniqueCarrier:function(){return null!==this.getUniqueCarrier()},getCarrierId:function(e){if(this.hasUniqueCarrier()){return this.getUniqueCarrier().getAttribute("value")}return e.querySelector("input[type=radio]").getAttribute("value")},getSelectedCarrier:function(){let e;if(this.hasUniqueCarrier()){e=this.getUniqueCarrier().getAttribute("value")}else{e=this.getSelectedInput().getAttribute("value")}return e},getSelectedCarrierText:function(e,t){if(null===e)return"";const n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState)if(200!==n.status)t.innerHTML="";else{const e="object"==typeof n.response&&null!==n.response?n.response:JSON.parse(n.response);t.innerHTML=e.text}},n.open("POST",bxAjaxUrl),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.responseType="json",n.send("route=getSelectedCarrierText&carrier="+encodeURIComponent(e)+"&cartId="+encodeURIComponent(bxCartId)+"&token="+encodeURIComponent(bxToken))},getSelectedInput:function(){var e=document.querySelector(".delivery-option input[type='radio']:checked");return null===e&&(e=document.querySelector(".delivery_option_radio input[type='radio']:checked")),null===e&&(e=document.querySelector(".delivery_option input[type='radio']:checked")),e},getAllCarrierInputsSelector:function(){let e=".delivery-option input[type='radio']";return e+=", .delivery_option_radio input[type='radio']",e+=", .delivery_option input[type='radio']",".delivery-option input[type='radio'], .delivery_option_radio input[type='radio'], .delivery_option input[type='radio']"},showError:function(e){this.closeMap(),alert(e)},on:function(e,t,n,o){const r=document.querySelector(e);r.addEventListener(t,function(e){const t=r.querySelectorAll(n),i=e.target;for(let n=0,a=t.length;n<a;n++){let a=i;const c=t[n];for(;a&&a!==r;){if(a===c)return o.call(c,e);a=a.parentNode}}})}};